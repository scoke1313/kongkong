<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>콩콩춘식 - 방향키 복구 및 모션 보정본</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poetsen+One&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@rive-app/canvas@latest"></script>
    <style>
        body { margin: 0; background: #333; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #game-stage { position: relative; width: 393px; height: 852px; background-color: #FFFDF5; overflow: hidden; }

        #main-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('bg_main.png'); background-size: 100% 100%; z-index: 2000; display: flex; flex-direction: column; align-items: center; }
        #main-rive-container { position: absolute; top: 0; left: 0; width: 393px; height: 852px; pointer-events: none; }
        #btn-start { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); width: 345px; cursor: pointer; z-index: 2100; transition: transform 0.1s; }

        .ingame-ui { display: none; }
        #bg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('bg_ingame.png'); background-repeat: repeat-y; background-size: 100% auto; z-index: 1; }
        #btn-close-wrap { position: absolute; top: 16px; left: 4px; width: 44px; height: 44px; z-index: 1001; cursor: pointer; }
        #btn-close-wrap img { width: 44px !important; height: 44px !important; display: block; object-fit: contain; }
        .header-ui-container { position: absolute; top: 75px; left: 0; width: 100%; height: 120px; z-index: 1000; pointer-events: none; }
        #score-board { position: absolute; top: 0; left: 20px; font-family: 'Poetsen One', sans-serif; font-size: 38px; color: #2D1D1C; line-height: 1; }
        
        .rate-capsule { position: absolute; top: -1px; right: 20px; width: 130px; height: 46px; background: #FFFFFF; border: 2px solid #F0E0C6; border-radius: 30px; box-sizing: border-box; overflow: visible; }
        .ui-icon { position: absolute; top: 9px; left: 12px; width: 25px; height: 25px; object-fit: contain; }
        #rate-board { position: absolute; top: 13px; left: 45px; font-size: 20px; font-weight: 800; color: #2D1D1C; font-family: 'Arial', sans-serif; line-height: 1; transform: translateY(-1px); white-space: nowrap; }

        #canvas-container { position: absolute; width: 86px !important; height: 138px !important; bottom: 100px; left: 50%; margin-left: -43px; z-index: 10; }
        canvas { width: 100%; height: 100%; }
        .platform { position: absolute; background-size: 100% 100%; z-index: 5; }
        .mouse-enemy { position: absolute; width: 72px; height: 54px; background-size: contain; background-repeat: no-repeat; z-index: 6; }
        .controller { position: absolute; width: 80px; height: 80px; background-size: contain; z-index: 50; cursor: pointer; }
        #btn-left { left: 30px; bottom: 40px; transform: scaleX(-1); }
        #btn-right { right: 30px; bottom: 40px; }
        .ctrl-default { background-image: url('controller_Default.png'); }
        .ctrl-pressed { background-image: url('controller_pressed.png'); }

        #result-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .result-popup { width: 345px; background: white; border-radius: 40px; padding: 40px 20px 30px; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; }
        .res-final-rate { font-size: 64px; font-weight: 900; color: #E76A6A; margin-bottom: 25px; font-family: 'Arial', sans-serif; }
        .res-btn-group { display: flex; gap: 10px; width: 345px; margin-top: 20px; }
        .res-btn { flex: 1; height: 65px; border-radius: 20px; border: none; font-size: 18px; font-weight: 800; cursor: pointer; }
    </style>
</head>
<body>
<div id="game-stage">
    <div id="main-screen">
        <div id="main-rive-container"><canvas id="main-rive-canvas"></canvas></div>
        <img src="btn_start.png" id="btn-start" onclick="startGame()">
    </div>
    <div id="bg-layer" class="ingame-ui"></div>
    <div id="btn-close-wrap" class="ingame-ui" onclick="location.reload();"><img src="close.png"></div>
    <div class="header-ui-container ingame-ui">
        <div id="score-board">0m</div>
        <div class="rate-capsule"><img src="clover_s.png" class="ui-icon"><span id="rate-board">0.00%</span></div>
    </div>
    <div id="canvas-container" class="ingame-ui"><canvas id="canvas"></canvas></div>
    <div id="btn-left" class="controller ctrl-default ingame-ui"></div>
    <div id="btn-right" class="controller ctrl-default ingame-ui"></div>
    <div id="result-screen">
        <div class="result-popup">
            <div class="res-final-rate" id="res-total-rate">0.00%</div>
            <img src="result_tip.png" style="width:140px; margin:20px 0;">
            <div style="font-weight:800; color:#2D1D1C;">이 금리로 적금을 만들까요?</div>
        </div>
        <div class="res-btn-group">
            <button class="res-btn" style="background:#333; color:white;" onclick="startGame()">다시하기</button>
            <button class="res-btn" style="background:#E76A6A; color:white;" onclick="location.reload()">적금 만들기</button>
        </div>
    </div>
</div>

<script>
// 점프 230px 보정 (-19.3), 이동 속도 7
const PHYSICS = { gravity: 0.81, jumpPower: -19.3, superJumpPower: -68, moveSpeed: 7 }; 
const SIZES = [138, 98, 58]; 
let score = 0, currentY = 0, velocityY = 0, posX = 0, platforms = [], isGameRunning = false, lastLoadedFile = "";
let riveInstance, mainRiveInstance, keys = {}, currentScale = 1, mouseAnimFrame = 0;

// 키보드 입력 감지 로직 추가
window.addEventListener('keydown', (e) => { if (e.code === 'ArrowLeft' || e.code === 'ArrowRight') keys[e.code] = true; });
window.addEventListener('keyup', (e) => { if (e.code === 'ArrowLeft' || e.code === 'ArrowRight') keys[e.code] = false; });

function loadMainRive() { 
    mainRiveInstance = new rive.Rive({ 
        src: 'kongsik.riv', 
        canvas: document.getElementById('main-rive-canvas'), 
        autoplay: true,
        stateMachines: 'State Machine 1',
        onLoad: () => { mainRiveInstance.resizeDrawingSurfaceToCanvas(); }
    }); 
}

function loadRive(f) { 
    if (lastLoadedFile === f) return;
    lastLoadedFile = f;
    if (riveInstance) riveInstance.cleanup();
    riveInstance = new rive.Rive({ 
        src: f, 
        canvas: document.getElementById('canvas'), 
        autoplay: true,
        stateMachines: 'State Machine 1',
        onLoad: () => { riveInstance.resizeDrawingSurfaceToCanvas(); }
    }); 
}

function startGame() { 
    document.getElementById('main-screen').style.display = 'none'; 
    document.getElementById('result-screen').style.display = 'none';
    document.querySelectorAll('.ingame-ui').forEach(el => el.style.display = 'block'); 
    isGameRunning = true; 
    initPlatforms(); 
    loadRive('kongsik_ingame_air.riv'); 
}

function createPlatformData(y) {
    let rand = Math.random();
    const width = SIZES[Math.floor(Math.random() * 3)];
    let canHaveMouse = (width >= 98) && (rand < 0.2); 
    return { x: Math.random() * (393 - width), y, baseY: y, w: width, h: 22, img: 'block_1.png', hasMouse: canHaveMouse, mouseX: Math.random() * (width - 72), mouseDir: 1, mouseSpeed: 1 };
}

function initPlatforms() { 
    score = 0; currentY = 0; velocityY = 0; posX = 0; platforms = []; 
    let lastY = 752; 
    for (let i = 0; i < 7; i++) { lastY -= (110 + Math.random() * 80); platforms.push(createPlatformData(lastY)); } 
    platforms.push({ x: 127, y: 752, baseY: 752, w: 138, h: 22, img: 'block_1.png' }); 
}

function update() {
    if (!isGameRunning) { requestAnimationFrame(update); return; }
    
    // 좌우 방향키 조작 로직 추가
    if (keys['ArrowLeft']) { posX -= PHYSICS.moveSpeed; currentScale = -1; }
    if (keys['ArrowRight']) { posX += PHYSICS.moveSpeed; currentScale = 1; }
    posX = Math.max(-154, Math.min(154, posX));

    velocityY += PHYSICS.gravity; currentY += velocityY; mouseAnimFrame = (mouseAnimFrame + 1) % 20;
    const charLeft = 196 + posX - 25, charFootY = 752 + currentY;

    platforms.forEach(p => {
        if (p.hasMouse) {
            p.mouseX += p.mouseDir * 1; if (p.mouseX <= 0 || p.mouseX + 72 >= p.w) p.mouseDir *= -1;
            let mx = p.x + p.mouseX, my = p.y - 35;
            if (charLeft + 30 > mx + 30 && charLeft + 20 < mx + 40 && charFootY > my && charFootY < my + 20) { 
                velocityY = -12; 
            }
        }
        if (velocityY > 0 && charLeft + 45 > p.x && charLeft + 5 < p.x + p.w && charFootY >= p.y && charFootY <= p.y + 15) { 
            loadRive('kongsik_ingame_land.riv');
            velocityY = PHYSICS.jumpPower; 
            currentY = p.y - 752; 
            setTimeout(() => { if(isGameRunning) loadRive('kongsik_ingame_air.riv'); }, 200);
        }
    });

    if (currentY < -250) { 
        let d = -250 - currentY; currentY = -250; score += d; 
        document.getElementById('score-board').innerText = Math.floor(score * 0.01) + "m";
        platforms.forEach(p => { 
            p.y += d; 
            if (p.y > 852) { Object.assign(p, createPlatformData(Math.min(...platforms.map(pl => pl.y)) - (110 + Math.random() * 80))); } 
        }); 
    }
    
    if (charFootY > 1050) {
        isGameRunning = false;
        document.getElementById('res-total-rate').innerText = (Math.floor(score * 0.01) * 0.01).toFixed(2) + "%";
        document.querySelectorAll('.ingame-ui').forEach(el => el.style.display = 'none');
        document.getElementById('result-screen').style.display = 'flex';
    }

    // 캐릭터 가로 이동 및 방향(scaleX) 적용
    document.getElementById('canvas-container').style.transform = `translate(${posX}px, ${currentY}px) scaleX(${currentScale})`;
    
    document.querySelectorAll('.platform, .mouse-enemy').forEach(el => el.remove());
    platforms.forEach(p => {
        const d = document.createElement('div'); d.className = 'platform'; d.style.cssText = `left:${p.x}px;top:${p.y}px;width:${p.w}px;height:22px;background-image:url('${p.img}');`; document.getElementById('game-stage').appendChild(d);
        if (p.hasMouse) { const m = document.createElement('div'); m.className = 'mouse-enemy'; m.style.cssText = `left:${p.x + p.mouseX}px;top:${p.y - 52}px;background-image:url('mouse_walk1.png'); transform: scaleX(${p.mouseDir})`; document.getElementById('game-stage').appendChild(m); }
    });
    requestAnimationFrame(update);
}
loadMainRive(); update();
</script>
</body>
</html>
