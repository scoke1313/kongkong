<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>콩콩춘식 - 최종 결과 화면 보정</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poetsen+One&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@rive-app/canvas@latest"></script>
    <style>
        body { margin: 0; background: #333; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #game-stage { position: relative; width: 393px; height: 852px; background-color: #FFFDF5; overflow: hidden; }

        /* --- 메인 화면 --- */
        #main-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('bg_main.png'); background-size: 100% 100%; z-index: 2000; display: flex; flex-direction: column; align-items: center; }
        #main-rive-container { position: absolute; top: 0; left: 0; width: 393px; height: 852px; pointer-events: none; }
        #btn-start { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); width: 345px; cursor: pointer; z-index: 2100; transition: transform 0.1s; }

        /* --- 인게임 UI --- */
        .ingame-ui { display: none; }
        #bg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('bg_ingame.png'); background-repeat: repeat-y; background-size: 100% auto; z-index: 1; }
        #btn-close-wrap { position: absolute; top: 16px; left: 4px; width: 44px; height: 44px; z-index: 1001; cursor: pointer; }
        #score-board { position: absolute; top: 75px; left: 20px; font-family: 'Poetsen One', sans-serif; font-size: 38px; color: #2D1D1C; line-height: 1; z-index: 1000; }
        .rate-capsule { position: absolute; top: 74px; right: 20px; width: 130px; height: 46px; background: #FFFFFF; border: 2px solid #F0E0C6; border-radius: 30px; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .ui-icon { width: 25px; height: 25px; margin-right: 6px; object-fit: contain; transform: translateY(1px); }
        #rate-board { font-size: 20px; font-weight: 800; color: #2D1D1C; font-family: 'Arial', sans-serif; }

        /* --- ★ 결과 화면 보정 (버튼 외부 배치) ★ --- */
        #result-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.4); z-index: 3000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .result-popup {
            width: 345px; background: white; border-radius: 40px;
            padding: 40px 20px 30px; box-sizing: border-box;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            position: relative;
        }
        .res-title { font-size: 18px; font-weight: 800; color: #2D1D1C; margin-bottom: 15px; }
        .res-final-rate { font-size: 64px; font-weight: 900; color: #E76A6A; margin-bottom: 25px; font-family: 'Arial', sans-serif; }
        
        .res-detail-row { display: flex; align-items: center; justify-content: center; margin-bottom: 12px; width: 100%; }
        .res-detail-icon { width: 24px; height: 24px; margin-right: 10px; object-fit: contain; }
        .res-detail-text { font-size: 18px; font-weight: 700; color: #2D1D1C; }

        .res-character { width: 140px; margin: 30px 0 20px; }
        .res-comment { font-size: 16px; font-weight: 800; color: #2D1D1C; line-height: 1.4; }

        /* 버튼 그룹을 팝업 밖 하단으로 배치 */
        .res-btn-group { 
            display: flex; gap: 10px; width: 345px; margin-top: 20px; 
        }
        .res-btn { flex: 1; height: 65px; border-radius: 20px; border: none; font-size: 18px; font-weight: 800; cursor: pointer; }
        .btn-retry { background: #333; color: white; }
        .btn-saving { background: #E76A6A; color: white; }

        /* 캐릭터/캔버스 */
        #canvas-container { position: absolute; width: 86px !important; height: 138px !important; bottom: 100px; left: 50%; margin-left: -43px; z-index: 10; }
        canvas { width: 100%; height: 100%; }
        .platform { position: absolute; background-size: 100% 100%; z-index: 5; }
        .game-item { position: absolute; width: 50px; height: 50px; background-size: contain; z-index: 7; }
        .controller { position: absolute; width: 80px; height: 80px; background-size: contain; z-index: 50; cursor: pointer; }
        #btn-left { left: 30px; bottom: 40px; transform: scaleX(-1); }
        #btn-right { right: 30px; bottom: 40px; }
        .ctrl-default { background-image: url('controller_Default.png'); }
        .ctrl-pressed { background-image: url('controller_pressed.png'); }
    </style>
</head>
<body>
<div id="game-stage">
    <div id="main-screen">
        <div id="main-rive-container"><canvas id="main-rive-canvas"></canvas></div>
        <img src="btn_start.png" id="btn-start" alt="시작하기" onclick="startGame()">
    </div>

    <div id="bg-layer" class="ingame-ui"></div>
    <div id="btn-close-wrap" class="ingame-ui" onclick="location.reload();"><img src="close.png" alt="close"></div>
    <div id="score-board" class="ingame-ui">0m</div>
    <div class="rate-capsule ingame-ui">
        <img src="clover_s.png" class="ui-icon" alt="clover">
        <span id="rate-board">0.00%</span>
    </div>
    
    <div id="canvas-container" class="ingame-ui"><canvas id="canvas"></canvas></div>
    <div id="btn-left" class="controller ctrl-default ingame-ui"></div>
    <div id="btn-right" class="controller ctrl-default ingame-ui"></div>

    <div id="result-screen">
        <div class="result-popup">
            <div class="res-title">금리 점프 챌린지 결과</div>
            <div class="res-final-rate" id="res-total-rate">0.00%</div>
            
            <div class="res-detail-row">
                <img src="pogo_s.png" class="res-detail-icon">
                <div class="res-detail-text"><span id="res-dist">0</span>m 기본 <span id="res-dist-rate">0.00</span>%</div>
            </div>
            <div class="res-detail-row">
                <img src="clover_s.png" class="res-detail-icon">
                <div class="res-detail-text"><span id="res-clover">0</span>개 우대 <span id="res-clover-rate">0.0</span>%</div>
            </div>

            <img src="result_tip.png" class="res-character">
            <div class="res-comment">꽤 괜찮은 금리네요!<br>이 금리로 적금을 만들까요?</div>
        </div>
        
        <div class="res-btn-group">
            <button class="res-btn btn-retry" onclick="startGame()">다시하기</button>
            <button class="res-btn btn-saving" onclick="location.reload()">적금 만들기</button>
        </div>
    </div>
</div>

<script>
// 물리 및 로직 (기존 사양 유지)
const PHYSICS = { gravity: 0.81, jumpPower: -19.3, superJumpPower: -68, moveSpeed: 7 }; 
const SIZES = [138, 98, 58]; 
let score = 0, cloverCount = 0, currentY = 0, velocityY = 0, posX = 0, bgScrollY = 0;
let riveInstance, mainRiveInstance, keys = {}, currentScale = 1, platforms = [], lastLoadedFile = "", isGameRunning = false;

const scoreEl = document.getElementById('score-board'), rateEl = document.getElementById('rate-board'), canvasCont = document.getElementById('canvas-container');

function loadMainRive() { mainRiveInstance = new rive.Rive({ src: 'kongsik.riv', canvas: document.getElementById('main-rive-canvas'), autoplay: true, stateMachines: 'State Machine 1', onLoad: () => mainRiveInstance.resizeDrawingSurfaceToCanvas() }); }
function startGame() { document.getElementById('main-screen').style.display = 'none'; document.getElementById('result-screen').style.display = 'none'; document.querySelectorAll('.ingame-ui').forEach(el => el.style.display = 'block'); isGameRunning = true; cloverCount = 0; initPlatforms(); loadRive('kongsik_ingame_air.riv'); }

function showResult() {
    isGameRunning = false;
    const finalDist = Math.floor(score * 0.01);
    const dRate = finalDist * 0.01;
    const cRate = cloverCount * 0.1;
    const totalRate = (dRate + cRate).toFixed(2);

    document.getElementById('res-total-rate').innerText = totalRate + "%";
    document.getElementById('res-dist').innerText = finalDist;
    document.getElementById('res-dist-rate').innerText = dRate.toFixed(2);
    document.getElementById('res-clover').innerText = cloverCount;
    document.getElementById('res-clover-rate').innerText = cRate.toFixed(1);

    document.querySelectorAll('.ingame-ui').forEach(el => el.style.display = 'none');
    document.getElementById('result-screen').style.display = 'flex';
}

const setInput = (key, isDown, btn) => { keys[key] = isDown; if(btn) { btn.classList.toggle('ctrl-default', !isDown); btn.classList.toggle('ctrl-pressed', isDown); }};
window.addEventListener('keydown', (e) => { if (e.code === 'ArrowLeft') setInput('ArrowLeft', true, document.getElementById('btn-left')); if (e.code === 'ArrowRight') setInput('ArrowRight', true, document.getElementById('btn-right')); });
window.addEventListener('keyup', (e) => { if (e.code === 'ArrowLeft') setInput('ArrowLeft', false, document.getElementById('btn-left')); if (e.code === 'ArrowRight') setInput('ArrowRight', false, document.getElementById('btn-right')); });

function loadRive(f) { if (lastLoadedFile === f) return; lastLoadedFile = f; if (riveInstance) riveInstance.cleanup(); riveInstance = new rive.Rive({ src: f, canvas: document.getElementById('canvas'), autoplay: true, stateMachines: 'State Machine 1', onLoad: () => riveInstance.resizeDrawingSurfaceToCanvas() }); }

function createPlatformData(y) {
    let distM = Math.floor(score * 0.01), rand = Math.random();
    let isBreakable = (rand < 0.15 + (Math.min(distM, 500) / 500) * 0.75);
    let moveType = (rand < Math.min(0.5, 0.1 + (0.4 * (distM / 500)))) ? (distM < 150 ? 'h' : (Math.random() > 0.5 ? 'h' : 'v')) : 'normal';
    let itemType = (rand > 0.8) ? (Math.random() > 0.6 ? 'gold' : 'clover') : null;
    let sIdx = distM < 100 ? Math.floor(rand * 2) : Math.floor(rand * 3);
    return { x: Math.random() * (393 - SIZES[sIdx]), y, baseY: y, w: SIZES[sIdx], h: 22, img: isBreakable ? 'wood_1.png' : 'block_1.png', isBreakable, item: itemType, itemCollected: false, type: moveType, speed: 1.6, verticalRange: 40, vPhase: Math.random() * 6.28, isBroken: false };
}

function initPlatforms() { score = 0; currentY = 0; velocityY = 0; posX = 0; scoreEl.innerText = "0m"; rateEl.innerText = "0.00%"; platforms = []; let lastY = 752; for (let i = 0; i < 7; i++) { lastY -= (110 + Math.random() * 100); platforms.push(createPlatformData(lastY)); } platforms.push({ x: 127, y: 752, baseY: 752, w: 138, h: 22, img: 'block_1.png', isBreakable: false, type: 'normal' }); }

function update() {
    if (!isGameRunning) { requestAnimationFrame(update); return; }
    if (keys['ArrowLeft']) { posX -= 7; currentScale = -1; } if (keys['ArrowRight']) { posX += 7; currentScale = 1; }
    posX = Math.max(-154, Math.min(154, posX)); velocityY += PHYSICS.gravity; currentY += velocityY;
    platforms.forEach(p => {
        if (!p.isBroken) {
            if (p.type === 'h') { p.x += p.speed; if (p.x <= 0 || p.x + p.w >= 393) p.speed *= -1; } 
            else if (p.type === 'v') { p.vPhase += 0.03; p.y = p.baseY + Math.sin(p.vPhase) * 40; }
            if (p.item && !p.itemCollected) {
                let ix = p.x + p.w/2 - 25, iy = p.y - 55;
                if (196 + posX + 20 > ix && 196 + posX - 20 < ix + 50 && 752 + currentY > iy && 752 + currentY < iy + 50) {
                    p.itemCollected = true;
                    if (p.item === 'clover') { cloverCount++; rateEl.innerText = `${(cloverCount * 0.1).toFixed(2)}%`; }
                    else if (p.item === 'gold') { velocityY = PHYSICS.superJumpPower; }
                }
            }
            if (velocityY > 0 && 196 + posX + 20 > p.x && 196 + posX - 20 < p.x + p.w && 752 + currentY >= p.y && 752 + currentY <= p.y + 15) { 
                loadRive('kongsik_ingame_land.riv'); velocityY = PHYSICS.jumpPower; currentY = p.y - 752; if (p.isBreakable) p.isBroken = true; 
                setTimeout(() => loadRive('kongsik_ingame_air.riv'), 200);
            }
        }
    });
    if (currentY < -250) { let d = -250 - currentY; currentY = -250; score += d; scoreEl.innerText = Math.floor(score * 0.01) + "m"; bgScrollY += d; document.getElementById('bg-layer').style.backgroundPositionY = (bgScrollY % 852) + 'px'; platforms.forEach(p => { p.y += d; p.baseY += d; if (p.y > 852) { Object.assign(p, createPlatformData(Math.min(...platforms.map(pl => pl.y)) - (110 + Math.random() * 100))); p.isBroken = false; } }); }
    if (752 + currentY > 1050) showResult();
    canvasCont.style.transform = `translate(${Math.floor(posX)}px, ${Math.floor(currentY)}px) scaleX(${currentScale})`;
    document.querySelectorAll('.platform, .game-item').forEach(el => el.remove());
    platforms.forEach(p => {
        if (!p.isBroken) {
            const d = document.createElement('div'); d.className = 'platform'; d.style.cssText = `left:${p.x}px;top:${p.y}px;width:${p.w}px;height:22px;background-image:url('${p.img}');`; document.getElementById('game-stage').appendChild(d);
            if (p.item && !p.itemCollected) { const it = document.createElement('div'); it.className = 'game-item'; it.style.backgroundImage = `url('item_${p.item}.png')`; it.style.left = (p.x + p.w/2 - 25) + 'px'; it.style.top = (p.y - 55) + 'px'; document.getElementById('game-stage').appendChild(it); }
        }
    });
    requestAnimationFrame(update);
}
loadMainRive();
update();
</script>
</body>
</html>
