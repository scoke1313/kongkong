<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>콩콩춘식 - 다차원 이동 발판 패치</title>
    <script src="https://unpkg.com/@rive-app/canvas@latest"></script>
    <style>
        body { margin: 0; background: #333; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #game-stage { 
            position: relative; width: 393px; height: 852px; 
            background-image: url('bg_ingame.png'); background-repeat: repeat-y;
            background-size: 100% auto; background-color: #FFFDF5; overflow: hidden; 
        }
        #canvas-container {
            position: absolute; width: 86px !important; height: 138px !important;
            bottom: 100px; left: 50%; margin-left: -43px; z-index: 10;
        }
        canvas { width: 100%; height: 100%; }
        .platform { position: absolute; background-size: 100% 100%; z-index: 5; transition: opacity 0.2s; }
        .mouse-enemy { position: absolute; width: 72px; height: 54px; background-size: contain; background-repeat: no-repeat; z-index: 6; }
        .particle { position: absolute; z-index: 4; pointer-events: none; border-radius: 1px; }
        .controller {
            position: absolute; width: 80px; height: 80px; background-size: contain;
            z-index: 50; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent;
        }
        #btn-left { left: 30px; bottom: 40px; transform: scaleX(-1); }
        #btn-right { right: 30px; bottom: 40px; }
        .ctrl-default { background-image: url('controller_Default.png'); }
        .ctrl-pressed { background-image: url('controller_pressed.png'); }
        #score-board { position: absolute; top: 20px; left: 20px; font-size: 24px; font-weight: bold; color: #5c3e34; z-index: 100; }
    </style>
</head>
<body>

<div id="game-stage">
    <div id="score-board">0m</div>
    <div id="canvas-container"><canvas id="canvas"></canvas></div>
    <div id="btn-left" class="controller ctrl-default"></div>
    <div id="btn-right" class="controller ctrl-default"></div>
</div>

<script>
const PHYSICS = { gravity: 0.81, jumpPower: -18.9, moveSpeed: 7, motionHold: 10 };
const PLATFORM_TYPES = { wood: ['wood_1.png', 'wood_2.png', 'wood_3.png'], block: ['block_1.png', 'block_2.png', 'block_3.png'] };
const SIZES = [138, 98, 58]; 

let currentY = 0, velocityY = 0, posX = 0, score = 0, bgScrollY = 0;
let riveInstance, keys = {}, currentScale = 1;
let platforms = [], particles = [], motionTimer = 0, lastLoadedFile = "";
let startTime = Date.now(), mouseAnimFrame = 0;

const btnLeft = document.getElementById('btn-left'), btnRight = document.getElementById('btn-right'), scoreEl = document.getElementById('score-board');

const setInput = (key, isDown, btn) => { 
    keys[key] = isDown; 
    if(btn) { btn.classList.toggle('ctrl-default', !isDown); btn.classList.toggle('ctrl-pressed', isDown); }
};

window.addEventListener('keydown', (e) => {
    if (e.code === 'ArrowLeft') setInput('ArrowLeft', true, btnLeft);
    if (e.code === 'ArrowRight') setInput('ArrowRight', true, btnRight);
});
window.addEventListener('keyup', (e) => {
    if (e.code === 'ArrowLeft') setInput('ArrowLeft', false, btnLeft);
    if (e.code === 'ArrowRight') setInput('ArrowRight', false, btnRight);
});

const attachControl = (btn, key) => {
    btn.addEventListener('touchstart', (e) => { e.preventDefault(); setInput(key, true, btn); });
    btn.addEventListener('touchend', (e) => { e.preventDefault(); setInput(key, false, btn); });
};
attachControl(btnLeft, 'ArrowLeft'); attachControl(btnRight, 'ArrowRight');

function loadRive(fileName) {
    if (lastLoadedFile === fileName) return;
    lastLoadedFile = fileName;
    if (riveInstance) riveInstance.cleanup();
    riveInstance = new rive.Rive({ src: fileName, canvas: document.getElementById('canvas'), autoplay: true, stateMachines: 'State Machine 1', onLoad: () => { riveInstance.resizeDrawingSurfaceToCanvas(); } });
}

function createPlatformData(yPos) {
    const sizeIdx = Math.floor(Math.random() * SIZES.length);
    const width = SIZES[sizeIdx];
    const rand = Math.random();
    let distM = Math.floor(score * 0.01);

    // ★ 거리별 나무 발판 비율 (100m~500m: 2%->10%)
    let woodProb = distM < 100 ? 0.02 : Math.min(0.1, 0.02 + (0.08 * ((distM - 100) / 400)));
    let isBreakable = rand < woodProb;
    const typeKey = isBreakable ? 'wood' : 'block';
    let canHaveMouse = (width === 138) && (rand < 0.2); 

    // ★ 거리별 이동 발판 비율 (100m~500m: 5%->30%)
    let moveProb = distM < 100 ? 0.05 : Math.min(0.3, 0.05 + (0.25 * ((distM - 100) / 400)));
    let moveType = 'normal';
    if (rand < moveProb) {
        moveType = Math.random() > 0.5 ? 'h' : 'v'; // 상하(v) 또는 좌우(h) 랜덤 선택
    }

    return {
        x: Math.random() * (393 - width), y: yPos, baseY: yPos, // 상하 이동 기준점 저장
        w: width, h: 22,
        img: PLATFORM_TYPES[typeKey][sizeIdx],
        isBreakable: isBreakable, durability: isBreakable ? 1 : 999,
        hasMouse: canHaveMouse, mouseX: Math.random() * (width - 72), mouseDir: Math.random() > 0.5 ? 1 : -1,
        mouseSpeed: 0.7 + Math.random() * 0.5, 
        mouseWaitTimer: 0, mouseYOffset: -52, mouseVY: 0,
        type: moveType, speed: 1.5, verticalRange: 40 + Math.random() * 40, // 이동 속도 및 상하 범위
        vPhase: Math.random() * Math.PI * 2, // 상하 이동 위기
        isBroken: false, isTouched: false
    };
}

function spawnBreakParticles(x, y, width) {
    for (let i = 0; i < 15; i++) {
        particles.push({
            x: x + Math.random() * width, y: y,
            vx: (Math.random() - 0.5) * 8, vy: (Math.random() - 1) * 6,
            life: 1.0, size: Math.random() * 3 + 2, color: '#BCAAA4'
        });
    }
}

function initPlatforms() {
    document.querySelectorAll('.platform, .mouse-enemy, .particle').forEach(el => el.remove());
    score = 0; scoreEl.innerText = "0m"; bgScrollY = 0; currentY = 0; velocityY = 0; posX = 0;
    document.getElementById('game-stage').style.backgroundPositionY = '0px';
    startTime = Date.now(); platforms = []; particles = [];
    let lastY = 752;
    for (let i = 0; i < 6; i++) {
        lastY -= (50 + Math.random() * 160); 
        platforms.push(createPlatformData(lastY));
    }
    platforms.push({ x: 393/2-69, y: 752, baseY: 752, w: 138, h: 22, img: 'block_1.png', isBreakable: false, durability: 999, isTouched: false, type: 'normal' });
}

loadRive('kongsik_ingame_air.riv');
initPlatforms();

function update() {
    if (keys['ArrowLeft']) { posX -= PHYSICS.moveSpeed; currentScale = -1; }
    if (keys['ArrowRight']) { posX += PHYSICS.moveSpeed; currentScale = 1; }
    const limit = 393/2 - 43;
    posX = Math.max(-limit, Math.min(limit, posX));

    velocityY += PHYSICS.gravity;
    currentY += velocityY;
    mouseAnimFrame = (mouseAnimFrame + 1) % 20;

    const charFootY = 752 + currentY, charLeft = 393/2 + posX - 25;

    platforms.forEach(p => {
        if (!p.isBroken) {
            // ★ 발판 이동 로직 (상하/좌우)
            if (p.type === 'h') { 
                p.x += p.speed; 
                if (p.x <= 0 || p.x + p.w >= 393) p.speed *= -1; 
            } else if (p.type === 'v') {
                p.vPhase += 0.03;
                p.y = p.baseY + Math.sin(p.vPhase) * p.verticalRange; // 상하 왕복 계산
            }

            // ★ 쥐돌이 AI 및 충돌
            if (p.hasMouse) {
                if (p.mouseWaitTimer > 0) p.mouseWaitTimer--;
                else {
                    p.mouseX += p.mouseDir * p.mouseSpeed;
                    if (p.mouseX <= 0 || p.mouseX + 72 >= p.w) {
                        p.mouseDir *= -1;
                        p.mouseWaitTimer = 30 + Math.floor(Math.random() * 90); 
                    } else if (Math.random() < 0.005) {
                        p.mouseWaitTimer = 20 + Math.floor(Math.random() * 40); 
                    }
                }
                let mx = p.x + p.mouseX, my = p.y - 35;
                if (charLeft + 35 > mx + 20 && charLeft + 15 < mx + 52 && charFootY > my && charFootY < my + 45) {
                    velocityY = -12; posX += (posX > (mx - p.x) ? 50 : -50); 
                }
            }

            // ★ 캐릭터 착지 체크
            if (velocityY > 0 && charLeft + 45 > p.x && charLeft + 5 < p.x + p.w && charFootY >= p.y && charFootY <= p.y + 15) {
                loadRive('kongsik_ingame_land.riv'); 
                velocityY = PHYSICS.jumpPower; currentY = p.y - 752; 
                motionTimer = PHYSICS.motionHold; 
                p.isTouched = true;
                if (p.isBreakable) { 
                    p.durability--; 
                    if (p.durability <= 0) {
                        p.isBroken = true;
                        spawnBreakParticles(p.x, p.y, p.w); 
                    }
                }
            }
        } else if (p.hasMouse) {
            // ★ 추락 쥐돌이
            p.mouseVY += 0.6; p.mouseYOffset += p.mouseVY;
        }
    });

    particles.forEach((part) => { part.x += part.vx; part.y += part.vy; part.vy += 0.4; part.life -= 0.02; });
    particles = particles.filter(part => part.life > 0);

    if (motionTimer > 0) { motionTimer--; if (motionTimer === 1) loadRive('kongsik_ingame_air.riv'); }

    if (currentY < -250) {
        let diff = -250 - currentY; currentY = -250; score += diff; 
        scoreEl.innerText = Math.floor(score * 0.01) + "m";
        bgScrollY += diff; document.getElementById('game-stage').style.backgroundPositionY = (bgScrollY % 852) + 'px';
        platforms.forEach(p => {
            p.y += diff; p.baseY += diff; // 기준점도 함께 이동
            if (p.y > 852 && p.baseY > 852) { 
                let randomGap = 50 + Math.random() * 160;
                Object.assign(p, createPlatformData(Math.min(...platforms.map(pl => pl.y)) - randomGap)); 
                p.isBroken = false; 
            }
        });
        particles.forEach(part => part.y += diff);
    }

    if (charFootY > 950) initPlatforms();

    document.getElementById('canvas-container').style.transform = `translate(${Math.floor(posX)}px, ${Math.floor(currentY)}px) scaleX(${currentScale})`;
    
    const stage = document.getElementById('game-stage');
    document.querySelectorAll('.platform, .mouse-enemy, .particle').forEach(el => el.remove());
    
    particles.forEach(part => {
        const pdiv = document.createElement('div');
        pdiv.className = 'particle';
        pdiv.style.cssText = `left:${part.x}px;top:${part.y}px;width:${part.size}px;height:${part.size}px;background-color:${part.color};opacity:${part.life};`;
        stage.appendChild(pdiv);
    });

    platforms.forEach(p => {
        if (!p.isBroken) {
            const d = document.createElement('div');
            d.className = 'platform'; 
            let opacity = (p.isBreakable && p.isTouched) ? 0.6 : 1.0;
            d.style.cssText = `left:${p.x}px;top:${p.y}px;width:${p.w}px;height:22px;background-image:url('${p.img}'); opacity:${opacity};`;
            stage.appendChild(d);
        }
        if (p.hasMouse) {
            const m = document.createElement('div');
            m.className = 'mouse-enemy';
            const mouseImg = (p.mouseWaitTimer > 0 || p.isBroken) ? 'mouse2.png' : `mouse_walk${mouseAnimFrame < 10 ? 1 : 2}.png`;
            m.style.cssText = `left:${p.x + p.mouseX}px;top:${p.y + p.mouseYOffset}px;background-image:url('${mouseImg}'); transform: scaleX(${p.mouseDir})`;
            stage.appendChild(m);
        }
    });
    requestAnimationFrame(update);
}
update();
</script>
</body>
</html>
