<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>콩콩춘식 - 스크롤 완전 동기화 패치</title>
    <script src="https://unpkg.com/@rive-app/canvas@latest"></script>
    <style>
        body { margin: 0; background: #333; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #game-stage { 
            position: relative; 
            width: 393px; 
            height: 852px; 
            background: #FFFDF5; 
            overflow: hidden; 
        }
        #bg-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }
        #canvas-container {
            position: absolute;
            width: 86px;
            height: 138px;
            bottom: 100px; 
            left: 50%;
            margin-left: -43px; 
            z-index: 10;
        }
        #char-canvas { width: 100%; height: 100%; }
        .platform { position: absolute; background-size: 100% 100%; background-repeat: no-repeat; z-index: 5; }
        .controller {
            position: absolute; width: 80px; height: 80px;
            background-size: contain; background-repeat: no-repeat;
            z-index: 50; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent;
        }
        #btn-left { left: 30px; bottom: 40px; transform: scaleX(-1); }
        #btn-right { right: 30px; bottom: 40px; }
        .ctrl-default { background-image: url('controller_Default.png'); }
        .ctrl-pressed { background-image: url('controller_pressed.png'); }
        #score-board {
            position: absolute; top: 20px; left: 20px; font-size: 24px; font-weight: bold;
            color: #5c3e34; z-index: 100; font-family: sans-serif;
        }
    </style>
</head>
<body>

<div id="game-stage">
    <canvas id="bg-canvas"></canvas>
    <div id="score-board">0m</div>
    <div id="canvas-container"><canvas id="char-canvas"></canvas></div>
    <div id="btn-left" class="controller ctrl-default"></div>
    <div id="btn-right" class="controller ctrl-default"></div>
</div>

<script>
const PHYSICS = {
    gravity: 0.81, jumpPower: -18.9, moveSpeed: 7,
    stageWidth: 393, stageHeight: 852, motionHold: 12,
    minGap: 150, maxGap: 190 
};

const bgCanvas = document.getElementById('bg-canvas');
const bgCtx = bgCanvas.getContext('2d');
bgCanvas.width = 393;
bgCanvas.height = 852;

const imgBgTile = new Image(); imgBgTile.src = 'bg_ingame.jpg';
const bgImgFiles = ['bg_block_1.png', 'bg_block_2.png', 'bg_block_3.png', 'bg_block_4.png', 'bg_block_5.png'];
const bgImages = bgImgFiles.map(src => { const img = new Image(); img.src = src; return img; });

let bgPattern = null;
let bgScrollY = 0;
let bgBricks = [];

imgBgTile.onload = () => { bgPattern = bgCtx.createPattern(imgBgTile, 'repeat'); };

const PLATFORM_TYPES = {
    wood: ['wood_1.png', 'wood_2.png', 'wood_3.png'],
    block: ['block_1.png', 'block_2.png', 'block_3.png']
};
const SIZES = [138, 98, 58];
const PLATFORM_H = 22;

let currentY = 0, velocityY = 0, posX = 0, score = 0;
let riveInstance, keys = {}, currentScale = 1;
let platforms = [], motionTimer = 0, lastLoadedFile = "";

class BackgroundBrick {
    constructor(y, isInitial = false) {
        this.img = bgImages[Math.floor(Math.random() * bgImages.length)];
        this.setSafePosition(y, isInitial);
    }

    setSafePosition(targetY, isInitial) {
        const bW = this.img.width / 2;
        // 화면 양옆으로 랜덤하게 삐져나올 수 있도록 배치
        this.x = Math.random() * (PHYSICS.stageWidth + bW) - bW;
        this.y = isInitial ? Math.random() * PHYSICS.stageHeight : targetY;
    }

    draw() { 
        if (this.img.complete) {
            // Math.floor로 정수 좌표 고정하여 떨림 및 밀림 방지
            bgCtx.drawImage(this.img, Math.floor(this.x), Math.floor(this.y), this.img.width/2, this.img.height/2); 
        } 
    }
}

// 조작 로직 (기존 동일)
const btnLeft = document.getElementById('btn-left');
const btnRight = document.getElementById('btn-right');
const scoreEl = document.getElementById('score-board');
function setBtnState(btn, isPressed) {
    btn.classList.toggle('ctrl-default', !isPressed);
    btn.classList.toggle('ctrl-pressed', isPressed);
}
const handleInput = (key, isDown, btn) => { keys[key] = isDown; setBtnState(btn, isDown); };
btnLeft.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput('ArrowLeft', true, btnLeft); });
btnLeft.addEventListener('touchend', (e) => { e.preventDefault(); handleInput('ArrowLeft', false, btnLeft); });
btnRight.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput('ArrowRight', true, btnRight); });
btnRight.addEventListener('touchend', (e) => { e.preventDefault(); handleInput('ArrowRight', false, btnRight); });

window.addEventListener('keydown', (e) => {
    if (e.code === 'ArrowLeft') handleInput('ArrowLeft', true, btnLeft);
    if (e.code === 'ArrowRight') handleInput('ArrowRight', true, btnRight);
});
window.addEventListener('keyup', (e) => {
    if (e.code === 'ArrowLeft') handleInput('ArrowLeft', false, btnLeft);
    if (e.code === 'ArrowRight') handleInput('ArrowRight', false, btnRight);
});

function loadRive(fileName) {
    if (lastLoadedFile === fileName) return;
    lastLoadedFile = fileName;
    if (riveInstance) riveInstance.cleanup();
    riveInstance = new rive.Rive({
        src: fileName, canvas: document.getElementById('char-canvas'),
        autoplay: true, stateMachines: 'State Machine 1',
        onLoad: () => { riveInstance.resizeDrawingSurfaceToCanvas(); }
    });
}

function createPlatformData(yPos) {
    const sizeIdx = Math.floor(Math.random() * SIZES.length);
    const width = SIZES[sizeIdx];
    let woodProbability = Math.min(0.05 + (score / 6000) * 0.85, 0.9);
    const isWood = Math.random() < woodProbability;
    const typeKey = isWood ? 'wood' : 'block';
    
    // 벽돌 생성 확률 낮춤 (한 화면 5개 이하 유지용)
    if (Math.random() < 0.15) bgBricks.push(new BackgroundBrick(yPos - 50));

    return {
        x: Math.random() * (PHYSICS.stageWidth - width),
        y: yPos, w: width, h: PLATFORM_H,
        img: PLATFORM_TYPES[typeKey][sizeIdx],
        isWood: isWood, durability: isWood ? 2 : 999,
        type: (Math.random() > 0.9) ? 'h' : 'normal',
        speed: (Math.random() * 1.5 + 1) * (Math.random() > 0.5 ? 1 : -1),
        isBroken: false
    };
}

function initPlatforms() {
    score = 0; scoreEl.innerText = "0m";
    platforms = []; bgBricks = []; bgScrollY = 0;
    // 초기 벽돌 3개만 생성
    for(let i=0; i<3; i++) bgBricks.push(new BackgroundBrick(0, true));
    let lastY = 752;
    for (let i = 0; i < 5; i++) {
        lastY -= (PHYSICS.minGap + Math.random() * 40);
        platforms.push(createPlatformData(lastY));
    }
    platforms.push({ x: PHYSICS.stageWidth/2 - 69, y: 752, w: 138, h: PLATFORM_H, img: 'block_1.png', isWood: false, durability: 999, type: 'normal' }); 
}

loadRive('kongsik_ingame_air.riv');
initPlatforms();

function update() {
    if (keys['ArrowLeft']) { posX -= PHYSICS.moveSpeed; currentScale = -1; }
    if (keys['ArrowRight']) { posX += PHYSICS.moveSpeed; currentScale = 1; }
    posX = Math.max(-153.5, Math.min(153.5, posX));

    velocityY += PHYSICS.gravity;
    currentY += velocityY;

    // 배경 렌더링
    bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
    if (bgPattern) {
        bgCtx.save();
        bgCtx.translate(0, Math.floor(bgScrollY % 512)); 
        bgCtx.fillStyle = bgPattern;
        bgCtx.fillRect(0, -512, bgCanvas.width, bgCanvas.height + 1024);
        bgCtx.restore();
    }
    bgBricks.forEach(brick => brick.draw());

    platforms.forEach(p => {
        if (!p.isBroken && p.type === 'h') {
            p.x += p.speed;
            if (p.x <= 0 || p.x + p.w >= PHYSICS.stageWidth) p.speed *= -1;
        }
    });

    if (motionTimer > 0) {
        motionTimer--;
        if (motionTimer < 10) loadRive('kongsik_ingame_air.riv');
    } else if (velocityY > 2) {
        loadRive('kongsik_ingame_land.riv');
    }

    const charFootY = 752 + currentY; 
    const charLeft = (393 / 2) + posX - 25;

    if (velocityY > 0) { 
        platforms.forEach(p => {
            if (!p.isBroken && charLeft + 50 > p.x && charLeft < p.x + p.w &&
                charFootY >= p.y && charFootY <= p.y + 15) {
                loadRive('kongsik_ingame_land.riv');
                velocityY = PHYSICS.jumpPower; 
                currentY = p.y - 752; 
                motionTimer = 12; 
                if (p.isWood) {
                    p.durability--;
                    if (p.durability <= 0) p.isBroken = true;
                }
            }
        });
    }

    // ★ 스크롤 업데이트 (완벽 동기화 구간) ★
    if (currentY < -250) {
        let diff = -250 - currentY;
        currentY = -250;
        score += Math.floor(diff);
        scoreEl.innerText = score + "m";
        
        // 플랫폼, 배경 타일, 벽돌을 한꺼번에 같은 diff만큼 이동
        bgScrollY += diff; 
        platforms.forEach(p => {
            p.y += diff;
            if (p.y > PHYSICS.stageHeight) {
                const highestY = Math.min(...platforms.map(plat => plat.y));
                Object.assign(p, createPlatformData(highestY - 170));
            }
        });
        bgBricks.forEach(b => { b.y += diff; });
        bgBricks = bgBricks.filter(b => b.y < PHYSICS.stageHeight + 200);
    }

    if (charFootY > 950) {
        initPlatforms();
        currentY = 0; velocityY = PHYSICS.jumpPower; 
        loadRive('kongsik_ingame_air.riv');
    }

    document.getElementById('canvas-container').style.transform = `translate(${Math.floor(posX)}px, ${Math.floor(currentY)}px) scaleX(${currentScale})`;
    renderPlatforms();
    requestAnimationFrame(update);
}

function renderPlatforms() {
    const stage = document.getElementById('game-stage');
    const existing = document.querySelectorAll('.platform');
    existing.forEach(el => el.remove());
    platforms.forEach(p => {
        if (p.isBroken) return;
        const div = document.createElement('div');
        div.className = 'platform';
        div.style.left = Math.floor(p.x) + 'px'; 
        div.style.top = Math.floor(p.y) + 'px';
        div.style.width = p.w + 'px'; div.style.height = p.h + 'px';
        div.style.backgroundImage = `url('${p.img}')`;
        if (p.isWood && p.durability === 1) div.style.opacity = '0.6';
        stage.appendChild(div);
    });
}
update();
</script>
</body>
</html>
