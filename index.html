<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>콩콩춘식 - UI 가시성 개선 패치</title>
    <script src="https://unpkg.com/@rive-app/canvas@latest"></script>
    <style>
        body { margin: 0; background: #333; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        
        #game-stage { 
            position: relative; width: 393px; height: 852px; 
            background-image: url('bg_ingame.png'); background-repeat: repeat-y;
            background-size: 100% auto; background-color: #FFFDF5; overflow: hidden; 
        }

        /* --- 상단 네비게이션 바 (유동폭 수정) --- */
        #nav-bar {
            position: absolute; top: 0; left: 0; width: 100%; max-width: 393px; height: 60px;
            display: flex; align-items: center; padding: 0 20px; box-sizing: border-box; z-index: 110;
        }
        #btn-close { width: 28px; height: 28px; cursor: pointer; }

        /* 숫자 UI 배치 */
        #score-board { position: absolute; top: 70px; left: 20px; font-size: 24px; font-weight: bold; color: #5c3e34; z-index: 100; }
        #rate-board { position: absolute; top: 70px; right: 20px; font-size: 22px; font-weight: bold; color: #2E7D32; z-index: 100; }

        #canvas-container {
            position: absolute; width: 86px !important; height: 138px !important;
            bottom: 100px; left: 50%; margin-left: -43px; z-index: 10;
        }

        /* 황금빛 번쩍임 효과 */
        @keyframes flicker {
            0% { opacity: 1; filter: drop-shadow(0 0 12px rgba(255, 190, 0, 0.8)) brightness(1.2); }
            50% { opacity: 0.8; filter: drop-shadow(0 0 25px rgba(255, 215, 0, 0.9)) brightness(1.5); }
            100% { opacity: 1; filter: drop-shadow(0 0 12px rgba(255, 190, 0, 0.8)) brightness(1.2); }
        }
        .gold-glow { animation: flicker 0.15s infinite; }

        canvas { width: 100%; height: 100%; }
        .platform { position: absolute; background-size: 100% 100%; z-index: 5; transition: opacity 0.2s; }
        .mouse-enemy { position: absolute; width: 72px; height: 54px; background-size: contain; background-repeat: no-repeat; z-index: 6; }
        
        /* 아이템 50px */
        .game-item { position: absolute; width: 50px; height: 50px; background-size: contain; background-repeat: no-repeat; z-index: 7; }
        
        /* ★ 픽업 이펙트 2배 확대 (160x80) */
        .pickup-effect { 
            position: absolute; width: 160px; height: 80px; 
            background-image: url('effect_pickup.png'); background-size: contain;
            background-repeat: no-repeat; background-position: center;
            z-index: 120; pointer-events: none; transition: transform 0.8s, opacity 0.8s; 
        }
        
        .particle { position: absolute; z-index: 4; pointer-events: none; border-radius: 1px; }
        
        /* 컨트롤러 */
        .controller {
            position: absolute; width: 80px; height: 80px; background-size: contain;
            z-index: 50; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent;
        }
        #btn-left { left: 30px; bottom: 40px; transform: scaleX(-1); }
        #btn-right { right: 30px; bottom: 40px; }
        .ctrl-default { background-image: url('controller_Default.png'); }
        .ctrl-pressed { background-image: url('controller_pressed.png'); }
    </style>
</head>
<body>

<div id="game-stage">
    <div id="nav-bar">
        <img src="Navigation.png" id="btn-close" alt="close" onclick="location.reload();">
    </div>

    <div id="score-board">0m</div>
    <div id="rate-board">Rate: +0.00%</div>

    <div id="canvas-container"><canvas id="canvas"></canvas></div>
    <div id="btn-left" class="controller ctrl-default"></div>
    <div id="btn-right" class="controller ctrl-default"></div>
</div>

<script>
const PHYSICS = { gravity: 0.81, jumpPower: -18.9, superJumpPower: -45, moveSpeed: 7, motionHold: 10 };
const PLATFORM_TYPES = { wood: ['wood_1.png', 'wood_2.png', 'wood_3.png'], block: ['block_1.png', 'block_2.png', 'block_3.png'] };
const SIZES = [138, 98, 58]; 

let currentY = 0, velocityY = 0, posX = 0, score = 0, cloverRate = 0, bgScrollY = 0;
let isSuperJumping = false;
let riveInstance, keys = {}, currentScale = 1;
let platforms = [], particles = [], motionTimer = 0, lastLoadedFile = "";
let mouseAnimFrame = 0;

const btnLeft = document.getElementById('btn-left'), btnRight = document.getElementById('btn-right'), 
      scoreEl = document.getElementById('score-board'), rateEl = document.getElementById('rate-board'),
      canvasCont = document.getElementById('canvas-container');

const setInput = (key, isDown, btn) => { 
    keys[key] = isDown; 
    if(btn) { btn.classList.toggle('ctrl-default', !isDown); btn.classList.toggle('ctrl-pressed', isDown); }
};

window.addEventListener('keydown', (e) => {
    if (e.code === 'ArrowLeft') setInput('ArrowLeft', true, btnLeft);
    if (e.code === 'ArrowRight') setInput('ArrowRight', true, btnRight);
});
window.addEventListener('keyup', (e) => {
    if (e.code === 'ArrowLeft') setInput('ArrowLeft', false, btnLeft);
    if (e.code === 'ArrowRight') setInput('ArrowRight', false, btnRight);
});

const attachControl = (btn, key) => {
    btn.addEventListener('touchstart', (e) => { e.preventDefault(); setInput(key, true, btn); });
    btn.addEventListener('touchend', (e) => { e.preventDefault(); setInput(key, false, btn); });
};
attachControl(btnLeft, 'ArrowLeft'); attachControl(btnRight, 'ArrowRight');

function loadRive(fileName) {
    if (lastLoadedFile === fileName) return;
    lastLoadedFile = fileName;
    if (riveInstance) riveInstance.cleanup();
    riveInstance = new rive.Rive({ src: fileName, canvas: document.getElementById('canvas'), autoplay: true, stateMachines: 'State Machine 1', onLoad: () => { riveInstance.resizeDrawingSurfaceToCanvas(); } });
}

function createPlatformData(yPos) {
    let distM = Math.floor(score * 0.01);
    const rand = Math.random();
    let sizeIdx = distM < 30 ? 0 : Math.floor(rand * SIZES.length);
    const width = SIZES[sizeIdx];
    let woodProb = 0.2 + (Math.min(distM, 500) / 500) * 0.7;
    let isBreakable = rand < woodProb;
    const typeKey = isBreakable ? 'wood
