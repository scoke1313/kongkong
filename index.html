<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>콩콩춘식 - 나무 부서지는 이펙트 추가본</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poetsen+One&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@rive-app/canvas@latest"></script>
    <style>
        body { margin: 0; background: #333; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #game-stage { position: relative; width: 393px; height: 852px; background-color: #FFFDF5; overflow: hidden; }

        /* 인게임 UI */
        .ingame-ui { display: none; }
        #bg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('bg_ingame.png'); background-repeat: repeat-y; background-size: 100% auto; z-index: 1; }
        #btn-close-wrap { position: absolute; top: 16px; left: 4px; width: 44px; height: 44px; z-index: 1001; cursor: pointer; }
        #btn-close-wrap img { width: 44px; height: 44px; display: block; }
        #score-board { position: absolute; top: 75px; left: 20px; font-family: 'Poetsen One', sans-serif; font-size: 38px; color: #2D1D1C; z-index: 1000; }
        .rate-capsule { position: absolute; top: 74px; right: 20px; width: 130px; height: 46px; background: #FFFFFF; border: 2px solid #F0E0C6; border-radius: 30px; z-index: 1000; }
        .ui-icon { position: absolute; top: 9px; left: 12px; width: 25px; height: 25px; }
        #rate-board { position: absolute; top: 13px; left: 45px; font-size: 20px; font-weight: 800; color: #2D1D1C; font-family: 'Arial', sans-serif; }

        /* 게임 요소 */
        #canvas-container { position: absolute; width: 86px; height: 138px; bottom: 100px; left: 50%; margin-left: -43px; z-index: 10; }
        canvas { width: 100%; height: 100%; }
        .platform { position: absolute; background-size: 100% 100%; z-index: 5; }
        .mouse-enemy { position: absolute; width: 72px; height: 54px; background-size: contain; background-repeat: no-repeat; z-index: 6; }
        .game-item { position: absolute; width: 50px; height: 50px; background-size: contain; z-index: 7; }
        
        /* 파편 이펙트 스타일 */
        .shard { position: absolute; width: 15px; height: 8px; background-image: url('wood_2.png'); background-size: cover; z-index: 4; pointer-events: none; }

        #result-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .result-popup { width: 345px; background: white; border-radius: 40px; padding: 40px 20px; text-align: center; }
    </style>
</head>
<body>
<div id="game-stage">
    <div id="main-screen" style="position:absolute; top:0; left:0; width:100%; height:100%; background-image:url('bg_main.png'); background-size:100% 100%; z-index:2000; display:flex; flex-direction:column; align-items:center;">
        <div id="main-rive-container" style="position:absolute; top:0; left:0; width:393px; height:852px; pointer-events:none;"><canvas id="main-rive-canvas"></canvas></div>
        <img src="btn_start.png" id="btn-start" style="position:absolute; bottom:50px; cursor:pointer;" onclick="startGame()">
    </div>
    <div id="bg-layer" class="ingame-ui"></div>
    <div id="btn-close-wrap" class="ingame-ui" onclick="location.reload();"><img src="close.png"></div>
    <div id="score-board" class="ingame-ui">0m</div>
    <div class="rate-capsule ingame-ui"><img src="clover_s.png" class="ui-icon"><span id="rate-board">0.00%</span></div>
    <div id="canvas-container" class="ingame-ui"><canvas id="canvas"></canvas></div>
    <div id="result-screen">
        <div class="result-popup">
            <div id="res-total-rate" style="font-size:64px; font-weight:900; color:#E76A6A;">0.00%</div>
            <img src="result_tip.png" style="width:140px; margin:20px 0;">
            <div style="font-weight:800; margin-bottom:20px;">이 금리로 적금을 만들까요?</div>
            <div style="display:flex; gap:10px;">
                <button onclick="startGame()" style="flex:1; height:65px; border-radius:20px; background:#333; color:white; border:none; font-weight:800;">다시하기</button>
                <button onclick="location.reload()" style="flex:1; height:65px; border-radius:20px; background:#E76A6A; color:white; border:none; font-weight:800;">적금 만들기</button>
            </div>
        </div>
    </div>
</div>

<script>
const PHYSICS = { gravity: 0.81, jumpPower: -19.3, superJumpPower: -68 }; 
const SIZES = [138, 98, 58]; 
let score = 0, cloverCount = 0, currentY = 0, velocityY = 0, posX = 0;
let riveInstance, mainRiveInstance, keys = {}, platforms = [], shards = [], isGameRunning = false, mouseAnimFrame = 0;

function loadMainRive() { mainRiveInstance = new rive.Rive({ src: 'kongsik.riv', canvas: document.getElementById('main-rive-canvas'), autoplay: true }); }
function startGame() { 
    document.getElementById('main-screen').style.display = 'none'; 
    document.getElementById('result-screen').style.display = 'none';
    document.querySelectorAll('.ingame-ui').forEach(el => el.style.display = 'block'); 
    isGameRunning = true; score = 0; cloverCount = 0; shards = []; initPlatforms(); loadRive('kongsik_ingame_air.riv'); 
}

function loadRive(f) { 
    if (riveInstance) riveInstance.cleanup();
    riveInstance = new rive.Rive({ src: f, canvas: document.getElementById('canvas'), autoplay: true }); 
}

window.addEventListener('keydown', (e) => { keys[e.code] = true; });
window.addEventListener('keyup', (e) => { keys[e.code] = false; });

// 파편 생성 함수
function createShards(x, y, w) {
    for (let i = 0; i < 5; i++) {
        shards.push({
            x: x + (Math.random() * w),
            y: y,
            vx: (Math.random() - 0.5) * 10,
            vy: (Math.random() - 0.5) * 10 - 5,
            rot: Math.random() * 360,
            rv: (Math.random() - 0.5) * 20,
            life: 1.0
        });
    }
}

function createPlatformData(y) {
    let distM = Math.floor(score * 0.01), rand = Math.random();
    let isBreakable = (rand < 0.2 + (Math.min(distM, 500) / 1000));
    let sIdx = distM < 100 ? Math.floor(rand * 2) : Math.floor(rand * 3);
    const width = SIZES[sIdx];
    let canHaveMouse = (width >= 98) && (rand < 0.2); 
    let itemType = (!canHaveMouse && rand > 0.85) ? (Math.random() > 0.6 ? 'gold' : 'clover') : null;
    return { x: Math.random() * (393 - width), y, w: width, h: 22, img: isBreakable ? 'wood_1.png' : 'block_1.png', isBreakable, item: itemType, itemCollected: false, hasMouse: canHaveMouse, mouseX: Math.random() * (width - 72), mouseDir: 1, isBroken: false };
}

function initPlatforms() { 
    platforms = []; let lastY = 752; 
    for (let i = 0; i < 7; i++) { lastY -= (120 + Math.random() * 70); platforms.push(createPlatformData(lastY)); } 
    platforms.push({ x: 127, y: 752, w: 138, h: 22, img: 'block_1.png', isBreakable: false, isBroken: false }); 
}

function update() {
    if (!isGameRunning) { requestAnimationFrame(update); return; }
    if (keys['ArrowLeft']) posX -= 7; if (keys['ArrowRight']) posX += 7;
    posX = Math.max(-154, Math.min(154, posX));
    velocityY += PHYSICS.gravity; currentY += velocityY; mouseAnimFrame = (mouseAnimFrame + 1) % 20;
    
    const charLeft = 196 + posX - 25, charFootY = 752 + currentY;

    // 파편 물리 업데이트
    shards.forEach((s, i) => {
        s.x += s.vx; s.y += s.vy; s.vy += 0.5; s.rot += s.rv; s.life -= 0.02;
        if (s.life <= 0) shards.splice(i, 1);
    });

    platforms.forEach(p => {
        if (p.hasMouse && !p.isBroken) {
            p.mouseX += p.mouseDir * 1.5; if (p.mouseX <= 0 || p.mouseX + 72 >= p.w) p.mouseDir *= -1;
            let mx = p.x + p.mouseX, my = p.y - 35;
            if (charLeft + 30 > mx + 25 && charLeft + 20 < mx + 45 && charFootY > my && charFootY < my + 20) { 
                velocityY = -12; posX += (posX > (mx - p.x) ? 50 : -50); 
            }
        }
        if (!p.isBroken) {
            if (velocityY > 0 && charLeft + 45 > p.x && charLeft + 5 < p.x + p.w && charFootY >= p.y && charFootY <= p.y + 15) { 
                velocityY = PHYSICS.jumpPower; currentY = p.y - 752; 
                if (p.isBreakable) { 
                    createShards(p.x, p.y, p.w); // 파편 생성 이펙트 실행
                    p.isBroken = true; 
                }
            }
            // 아이템 처리 생략...
        }
    });

    if (currentY < -250) { 
        let d = -250 - currentY; currentY = -250; score += d; 
        document.getElementById('score-board').innerText = Math.floor(score * 0.01) + "m";
        platforms.forEach(p => { p.y += d; if (p.y > 852) Object.assign(p, createPlatformData(Math.min(...platforms.map(pl => pl.y)) - (120 + Math.random() * 70))); }); 
        shards.forEach(s => s.y += d);
    }
    if (charFootY > 1050) { isGameRunning = false; document.getElementById('res-total-rate').innerText = (Math.floor(score * 0.01) * 0.01).toFixed(2) + "%"; document.getElementById('result-screen').style.display = 'flex'; }

    document.getElementById('canvas-container').style.transform = `translate(${posX}px, ${currentY}px) scaleX(${keys['ArrowLeft'] ? -1 : 1})`;
    document.querySelectorAll('.platform, .mouse-enemy, .shard').forEach(el => el.remove());
    
    shards.forEach(s => {
        const sd = document.createElement('div'); sd.className = 'shard';
        sd.style.cssText = `left:${s.x}px;top:${s.y}px;transform:rotate(${s.rot}deg);opacity:${s.life};`;
        document.getElementById('game-stage').appendChild(sd);
    });

    platforms.forEach(p => {
        if (!p.isBroken) {
            const d = document.createElement('div'); d.className = 'platform';
            d.style.cssText = `left:${p.x}px;top:${p.y}px;width:${p.w}px;height:22px;background-image:url('${p.img}');`;
            document.getElementById('game-stage').appendChild(d);
        }
        if (p.hasMouse && !p.isBroken) {
            const m = document.createElement('div'); m.className = 'mouse-enemy';
            m.style.cssText = `left:${p.x + p.mouseX}px;top:${p.y - 52}px;background-image:url('mouse_walk1.png'); transform: scaleX(${p.mouseDir})`;
            document.getElementById('game-stage').appendChild(m);
        }
    });
    requestAnimationFrame(update);
}
loadMainRive(); update();
</script>
</body>
</html>
